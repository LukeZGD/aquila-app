#include "util.h"
#include "oob_entry.h"
#include "memory.h"
#include "patchfinder.h"
#include "patches.h"

static void *kernel_data = NULL;
static size_t kernel_data_size = 0xffe000;

uint32_t find_patch_offset(uint32_t (*func)(uint32_t, uint8_t *, size_t)) {
    uint32_t addr = func(kinfo->kernel_base, kernel_data, kernel_data_size);
    if (addr <= 0xffff) return 0;
    return addr + kinfo->kernel_base;
}

void set_bootargs(patches_t *patches, const char *bootargs) {
    size_t args_size = strlen(bootargs) + 1;
    size_t buf_size = (args_size + 3) / 4 * 4;
    
    char *buf = calloc(1, buf_size);
    strlcpy(buf, bootargs, buf_size);
    memset(buf + args_size, 0, buf_size - args_size);
    
    uint32_t str_addr = kread32(patches->p_bootargs) + 0x38;
    kwrite_buf(str_addr, buf, args_size);
    free(buf);
    usleep(10000);
}

int patch_kernel(void) {
    patches_t *patches = calloc(1, sizeof(patches_t));
    kernel_data = calloc(1, kernel_data_size);
    kread_buf(kinfo->kernel_base, kernel_data, kernel_data_size);
    int rv = -1;

    if ((patches->proc_enforce = find_patch_offset(find_proc_enforce)) == 0) goto done;
    if ((patches->cs_enforcement_disable_amfi = find_patch_offset(find_cs_enforcement_disable_amfi)) == 0) goto done;
    if ((patches->cs_enforcement_disable_kernel = find_patch_offset(find_cs_enforcement_disable_kernel)) == 0) goto done;
    if ((patches->i_can_has_debugger_1 = find_patch_offset(find_i_can_has_debugger_1)) == 0) goto done;
    if ((patches->i_can_has_debugger_2 = find_patch_offset(find_i_can_has_debugger_2)) == 0) goto done;
    if ((patches->vm_map_enter_patch = find_patch_offset(find_vm_map_enter_patch)) == 0) goto done;
    if ((patches->vm_map_protect_patch = find_patch_offset(find_vm_map_protect_patch)) == 0) goto done;
    if ((patches->tfp0_patch = find_patch_offset(find_tfp0_patch)) == 0) goto done;
    if ((patches->p_bootargs = find_patch_offset(find_p_bootargs)) == 0) goto done;

    kwrite8(patches->proc_enforce, 0);
    kwrite8(patches->cs_enforcement_disable_amfi, 1);
    kwrite8(patches->cs_enforcement_disable_kernel, 1);
    kwrite8(patches->i_can_has_debugger_1, 1);
    kwrite8(patches->i_can_has_debugger_2, 1);

    kwrite16_exec(patches->vm_map_enter_patch, 0xbf00);
    kwrite16_exec(patches->vm_map_protect_patch, 0xe005);
    kwrite16_exec(patches->tfp0_patch, 0xe006);
    set_bootargs(patches, "cs_enforcement_disable=1");

    rv = 0;

done:
    if (patches != NULL) free(patches);
    if (kernel_data != NULL) free(kernel_data);
    return rv;
}
