//
//  util.h
//  queue_6
//
//  Created by staturnz on 5/15/25.
//

#ifndef util_h
#define util_h

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <mach/mach.h>
#include <mach-o/dyld.h>
#include <mach-o/dyld_images.h>
#include <mach-o/loader.h>
#include <mach-o/fat.h>
#include <mach-o/swap.h>
#include <sys/sysctl.h>
#include <sys/syscall.h>
#include <sys/socket.h>
#include <fcntl.h>
#include <dlfcn.h>
#include <CoreFoundation/CoreFoundation.h>
#include <netinet/in.h>
#include <stdarg.h>
#include <sys/syslog.h>
#include <device/device_types.h>
#include <pthread.h>
#include <sys/mount.h>
#include <sys/dirent.h>
#include <spawn.h>

#define kIORegistryIterateRecursively 0x00000001
#define find_io_sym(name) if ((name = dlsym(handle, #name)) == NULL) return -1;

typedef uint32_t io_object_t;
typedef io_object_t io_connect_t;
typedef io_object_t io_service_t;
typedef io_object_t io_registry_entry_t;
typedef uint32_t IOSurfaceLockOptions;
typedef void * IOSurfaceRef;
typedef uint32_t IOOptionBits;
typedef uint32_t IOHIDEventOptionBits;
typedef uint32_t IOHIDEventField;
typedef struct __IOHIDEventSystemClient * IOHIDEventSystemClientRef;
typedef struct __IOHIDEvent * IOHIDEventRef;
typedef char io_name_t[128];
typedef char io_struct_inband_t[4096];
typedef char *io_buf_ptr_t;

#pragma pack(4)
typedef struct {
    mach_msg_header_t Head;
    NDR_record_t NDR;
    mach_msg_type_number_t matchingOffset;
    mach_msg_type_number_t matchingCnt;
    char matching[512];
} get_matching_services_request_t;
#pragma pack()

#pragma pack(4)
typedef struct {
    mach_msg_header_t Head;
    mach_msg_body_t msgh_body;
    mach_msg_port_descriptor_t main;
} get_io_main_request_t;
#pragma pack()

#pragma pack(4)
typedef struct {
    mach_msg_header_t Head;
    mach_msg_body_t msgh_body;
    mach_msg_port_descriptor_t owningTask;
    mach_msg_ool_descriptor_t properties;
    NDR_record_t NDR;
    uint32_t connect_type;
    NDR_record_t ndr;
    mach_msg_type_number_t propertiesCnt;
} service_open_request_t;
#pragma pack()


#pragma pack(4)
typedef struct {
    mach_msg_header_t Head;
} io_iterator_next_request_t;
#pragma pack()

#pragma pack(4)
typedef struct {
    mach_msg_header_t Head;
    mach_msg_body_t msgh_body;
    mach_msg_port_descriptor_t object;
} io_iterator_next_reply_t;
#pragma pack()

#pragma pack(4)
typedef struct {
    mach_msg_header_t Head;
    mach_msg_body_t msgh_body;
    mach_msg_port_descriptor_t connection;
    NDR_record_t NDR;
    kern_return_t result;
} service_open_reply_t;
#pragma pack()

#pragma pack(4)
typedef struct {
  mach_msg_header_t Head;
  mach_msg_body_t msgh_body;
  mach_msg_port_descriptor_t port;
  NDR_record_t NDR;
  uint32_t notification_type;
  uint32_t reference;
} set_notification_request_t;
#pragma pack()

#pragma pack(4)
typedef struct {
  mach_msg_header_t Head;
  NDR_record_t NDR;
  kern_return_t RetCode;
  mach_msg_trailer_t trailer;
} set_notification_reply_t;
#pragma pack()

extern void notify_post(const char *name);
extern void mach_reply_port(void);
extern kern_return_t mach_vm_map(vm_map_t, mach_vm_address_t *, mach_vm_size_t, mach_vm_offset_t, int, mem_entry_name_port_t, memory_object_offset_t, boolean_t, vm_prot_t, vm_prot_t, vm_inherit_t);
extern kern_return_t mach_vm_deallocate(vm_map_t, mach_vm_address_t, mach_vm_size_t);
extern kern_return_t mach_vm_allocate(vm_map_t, mach_vm_address_t *, mach_vm_size_t, int);
extern kern_return_t mach_vm_copy(vm_map_t, mach_vm_address_t, mach_vm_size_t, mach_vm_address_t);
extern kern_return_t mach_vm_read_overwrite(vm_map_read_t, mach_vm_address_t, mach_vm_size_t, mach_vm_address_t, mach_vm_size_t *);
extern kern_return_t mach_vm_write(vm_map_t, mach_vm_address_t, vm_offset_t, mach_msg_type_number_t);
extern kern_return_t bootstrap_look_up(mach_port_t, char *, mach_port_t *);
void vsyslog(int, const char *, __darwin_va_list);

extern kern_return_t (*io_hideventsystem_open)(mach_port_t, mach_port_t, mach_port_t *);
extern kern_return_t (*io_hideventsystem_clear_service_cache)(mach_port_t);
extern kern_return_t (*io_hideventsystem_copy_matching_services)(mach_port_t, void *, int, mach_vm_address_t *, mach_vm_size_t *, mach_vm_address_t *, mach_vm_size_t *);
extern kern_return_t (*io_hideventsystem_queue_create)(mach_port_t, mach_port_t, int, mach_port_t *);
extern kern_return_t (*io_hideventsystem_queue_start)(mach_port_t);
extern kern_return_t (*io_hideventsystem_queue_stop)(mach_port_t);
extern io_service_t (*IOServiceGetMatchingService)(mach_port_t mainPort, CFDictionaryRef matching);
extern CFMutableDictionaryRef (*IOServiceMatching)(const char *name);
extern io_object_t (*IOIteratorNext)(uint32_t iterator);
extern kern_return_t (*IOObjectRelease)(io_object_t);
extern kern_return_t (*IOConnectMapMemory)(io_connect_t, uint32_t, task_port_t, vm_address_t *, vm_size_t *, uint32_t);
extern kern_return_t (*IOConnectSetNotificationPort)(io_connect_t, uint32_t, mach_port_t, uintptr_t);
extern kern_return_t (*IOConnectCallMethod)(mach_port_t, uint32_t, uint64_t *, uint32_t, void *, size_t, uint64_t *, uint32_t *, void *, size_t *);
extern IOHIDEventRef (*IOHIDEventCreateKeyboardEvent)(CFAllocatorRef, uint64_t, uint16_t, uint16_t, Boolean, uint32_t flags);
extern IOHIDEventSystemClientRef (*IOHIDEventSystemClientCreate)(CFAllocatorRef);
extern void (*IOHIDEventSetSenderID)(IOHIDEventRef, uint64_t);
extern void (*IOHIDEventSystemClientDispatchEvent)(IOHIDEventSystemClientRef, IOHIDEventRef);
extern IOHIDEventRef (*IOHIDEventCreateAccelerometerEvent)(CFAllocatorRef, uint64_t, float, float, float, IOOptionBits options);
extern kern_return_t (*IORegistryEntryGetProperty)(io_registry_entry_t, const io_name_t, io_struct_inband_t, uint32_t *);
extern kern_return_t (*IOServiceClose)(io_connect_t);
extern kern_return_t (*io_service_open_extended)(mach_port_t, task_t, uint32_t, NDR_record_t, io_buf_ptr_t, mach_msg_type_number_t, kern_return_t *, mach_port_t *);
extern kern_return_t (*IORegistryEntryCreateIterator)(io_registry_entry_t, const io_name_t, IOOptionBits, mach_port_t *);
extern CFTypeRef (*IORegistryEntryCreateCFProperty)(io_registry_entry_t entry, CFStringRef key, CFAllocatorRef allocator, IOOptionBits options);
extern kern_return_t (*IOServiceGetMatchingServices)(mach_port_t mainPort, CFDictionaryRef matching, mach_port_t *existing);
extern kern_return_t (*IOConnectSetCFProperty)(io_connect_t connect, CFStringRef propertyName, CFTypeRef property);
extern kern_return_t (*IOServiceOpen)(io_service_t, task_port_t, uint32_t, io_connect_t *);
extern kern_return_t (*IORegistryEntryCreateCFProperties)(io_registry_entry_t entry, CFMutableDictionaryRef *properties, CFAllocatorRef allocator, IOOptionBits options);

void print_log(const char *fmt, ...);
int init_io(void);
size_t task_read(mach_port_t task, uint32_t addr, void *buf, size_t size);
size_t task_write(mach_port_t task, uint32_t addr, void *buf, size_t size);
uint32_t task_alloc(mach_port_t task, uint32_t size);
uint32_t task_free(mach_port_t task, uint32_t addr, uint32_t size);
uint32_t task_call(mach_port_t task, uint32_t ptr, void *stack_data, uint32_t stack_data_size, uint32_t r0, uint32_t r1, uint32_t r2, uint32_t r3);
int task_mach_msg(mach_port_t task, mach_msg_header_t *msg, int32_t opt, uint32_t send_size, uint32_t rcv_size, mach_port_t rcv_name, uint32_t timeout, mach_port_t notify);
mach_port_name_t task_get_host_self(mach_port_t task);
mach_port_name_t task_get_io_main_port(mach_port_t task, mach_port_name_t host);
mach_port_name_t task_get_io_service(mach_port_t task, mach_port_name_t host, mach_port_name_t io_main, const char *name);
mach_port_name_t task_get_io_services(mach_port_t task, mach_port_name_t host, mach_port_name_t io_main, const char *name);
mach_port_name_t task_open_io_service(mach_port_t task, const char *name);
mach_port_name_t task_io_iterator_next(mach_port_t task, mach_port_name_t iterator);
mach_port_name_t task_open_io_service_class(mach_port_t task, const char *service_name, const char *class_name);
mach_port_t task_extract_port(mach_port_t task, mach_port_name_t target_port);
kern_return_t io_connect_set_notification_port_copy_send(mach_port_t connect, uint32_t type, mach_port_t port, uint32_t ref);

uint32_t find_port(mach_port_t port);

#endif /* util_h */
